# 开发进度记录
## 说明
- 本文件用于记录后续开发进展，按阶段或每日更新。
- 记录需简洁客观，聚焦完成内容、待办与风险。
## 记录模板
- 日期：
- 阶段/模块：
- 完成内容：
- 待办：
- 风险/阻塞：
- 下一步：

---

## 记录 #1
- 日期：2026-02-12
- 阶段/模块：M1 项目骨架与数据层
- 完成内容：
  - 创建 Android Studio 工程结构（Kotlin + Compose + Room + KSP）
  - 配置 Gradle（Version Catalog）：AGP 8.4.0, Kotlin 2.0.0, Compose BOM 2024.05, Room 2.6.1
  - Room 实体：Book、Word、Progress、NewWordRef
  - DAO 接口：BookDao、WordDao、ProgressDao、NewWordRefDao
  - AppDatabase 单例 + 首次启动预填充（生词本 + 考研核心词汇示例数据）
  - WordRepository 封装全部数据操作
  - UI 主题（Color/Type/Theme）按 UI 文档色彩字体规范，支持深色模式
  - BottomNav 四 Tab 导航框架 + 四个占位 Screen
  - MainActivity + KaoyanWordApp (Application)
  - AndroidManifest 无网络权限
- 待办：无
- 风险/阻塞：无
- 下一步：M2 词书管理与切换、生词本基础逻辑

## 记录 #2
- 日期：2026-02-12
- 阶段/模块：M2 词书管理与切换、生词本基础逻辑
- 完成内容：
  - 词书管理页面：列表展示、进度条、切换、导入预览、删除/清空规则
  - 文件导入解析工具与导入流程（TXT/CSV 简易解析）
  - 生词本逻辑：加入/移除/清空、数量同步、学习页与查词页入口
  - 学习页基础展示：词书切换浮层、单词卡片、操作按钮
  - 查词页基础搜索与星标生词入口
- 待办：M3 学习流程与记忆调度算法
- 风险/阻塞：无
- 下一步：完善学习流程与调度算法（M3）

## 记录 #3
- 日期：2026-02-12
- 阶段/模块：M3 学习流程与记忆调度算法
- 完成内容：
  - 引入 SM-2 记忆调度（ease factor / repetitions / interval）
  - Progress 表新增 repetitions 与 interval_days，并添加数据库迁移
  - 学习队列基于“到期复习 + 新词批次”生成
  - 学习页卡片翻转交互，按钮接入调度；生词本“认识”支持移出并记录进度
- 待办：M4 查词与详情页完善
- 风险/阻塞：无
- 下一步：推进查词详情页与交互（M4）

## 记录 #4
- 日期：2026-02-12
- 阶段/模块：M4 查词与详情页
- 完成内容：
  - 查词结果列表布局优化，保留星标生词入口
  - 词条详情页（底部弹出）展示完整释义与例句
  - 详情页加入生词本按钮与状态反馈
- 待办：M5 我的页统计、备份/恢复与设置
- 风险/阻塞：无
- 下一步：推进 M5 我的模块

## 记录 #5
- 日期：2026-02-12
- 阶段/模块：M5 我的页统计、备份/恢复与设置
- 完成内容：
  - 我的页重构：学习统计卡片、打卡日历、数据管理、学习设置与关于信息
  - 新增学习统计数据表（StudyLog）与迁移，学习行为自动记录
  - 数据备份/恢复（SAF 导出/导入 .db 文件，恢复提示重启）
  - 学习设置：每组新词数量、字号、深色模式（DataStore 持久化）
  - 主题支持字号缩放，学习队列使用设置的新词数量
- 待办：M6 UI 动效与验收测试
- 风险/阻塞：无
- 下一步：推进 M6 动效与验收测试

## 记录 #6
- 日期：2026-02-12
- 阶段/模块：M6 UI 动效与验收测试
- 完成内容：
  - 学习页卡片切换动效：认识/不认识滑出+淡入，模糊淡出+缩放
  - 卡片翻转动效统一 300ms
  - 星标加入生词本弹跳动效（学习页/查词页）
  - 词书名称切换渐隐渐显
  - 新增基础 Compose UI 验收测试（学习/查词/词库/我的导航与核心元素）
- 待办：在真机/模拟器运行 UI 验收测试
- 风险/阻塞：无
- 下一步：执行并确认 M6 验收测试结果

## 记录 #7
- 日期：2026-02-12
- 阶段/模块：M7 数据层扩展
- 完成内容：
  - Progress 表新增 review_count、spell_correct_count、spell_wrong_count 字段
  - 新增 DailyStats 实体与 DailyStatsDao（按日期范围查询、按天聚合、getOrCreate）
  - 数据库迁移升级至 v4（新增 Progress 字段与 DailyStats 表/索引）
  - Repository 增加每日统计查询与拼写记录方法，并在学习结果中写入统计数据
- 待办：M8 复习时间可视化
- 风险/阻塞：无
- 下一步：实现复习时间展示与相关工具类（M8）

## 记录 #8
- 日期：2026-02-12
- 阶段/模块：M8 复习时间可视化
- 完成内容：
  - 新增 DateUtils：时间戳友好文案与格式化展示
  - 学习页卡片新增复习时间标签，点击弹窗展示上次/下次复习时间与调度说明
  - 查词详情页展示掌握状态与下次复习时间
- 待办：M9 拼写练习功能
- 风险/阻塞：无
- 下一步：实现拼写模式与拼写练习流程（M9）

## 记录 #9
- 日期：2026-02-12
- 阶段/模块：M9 拼写练习功能
- 完成内容：
  - 学习页新增模式切换 Tabs（认词/拼写），支持从词库页进入拼写模式
  - 新增 SpellingScreen：释义/音标出题、输入拼写、实时纠错提示、提示功能（首字母/长度）
  - 拼写判定与统计：正确/错误计数写入，正确自动跳转，错误显示正确拼写与“记住了”
- 待办：M10 学习数据可视化
- 风险/阻塞：无
- 下一步：图表库选型与统计图表页面（M10）

## 记录 #10
- 日期：2026-02-12
- 阶段/模块：M10 学习数据可视化
- 完成内容：
  - 引入 MPAndroidChart 图表依赖并配置 JitPack 仓库
  - 新增 StatsViewModel：7/30 天统计曲线、掌握度分布、日历热力图数据
  - 新增 StatsScreen：记忆曲线折线图、掌握度环形图、日历热力图
  - 我的页新增“学习数据”入口，导航至统计页
- 待办：M11 现有页面改造
- 风险/阻塞：无
- 下一步：推进 M11 词书列表/详情页统计与我的页统计升级

## 记录 #11
- 日期：2026-02-12
- 阶段/模块：M11 现有页面改造
- 完成内容：
  - 词书列表新增已掌握率与预计复习数展示
  - 词书详情弹窗增加掌握度环形图与统计信息
  - 我的页统计升级为日历热力图 + 过去一周趋势图，并展示拼写练习统计
  - 查词结果列表展示单词掌握状态与下次复习信息
- 待办：M12 UI适配与验收测试
- 风险/阻塞：无
- 下一步：进行深色模式适配与回归测试

## 记录 #12
- 日期：2026-02-12
- 阶段/模块：M12 UI适配与验收测试
- 完成内容：
  - 拼写练习界面增加滚动与 IME 适配，避免软键盘遮挡
  - StatsScreen 抽取可测试内容组件并补充图表渲染验收测试
  - 新增拼写流程 UI 测试、复习时间/时区格式化测试
  - 新增 Room 迁移测试覆盖 v1→v4 数据保留与字段默认值
  - 引入 Room 测试依赖
- 待办：回归测试（学习/查词/词库管理/我的）
- 风险/阻塞：未在本地执行仪器化测试
- 下一步：运行 androidTest 并验证深色模式表现

## 记录 #13
- 日期：2026-02-12
- 阶段/模块：M12 UI适配与验收测试（启动补充）
- 完成内容：
  - 学习页复习时间标签补充 `learning_review_tag`，用于“复习时间展示”验收测试
  - 拼写页增加 `navigationBarsPadding + imePadding` 组合，强化软键盘与底部安全区适配
  - 新增 M12 仪器化验收测试：拼写流程、复习时间弹窗、统计页图表入口、核心流程回归与深色模式切换冒烟
  - 补充深色模式渲染测试：`SpellingScreenTest`、`StatsContentTest`
- 待办：
  - 在模拟器/真机执行 `connectedDebugAndroidTest`
  - 手动验证拼写页在不同屏幕尺寸下的软键盘遮挡情况
  - 完成学习/查词/词库管理/我的四大流程回归结果记录
- 风险/阻塞：当前环境未执行真实设备仪器化回归，结果仍待验证
- 下一步：跑通 M12 全量 androidTest 并整理失败用例修复

## 记录 #14
- 日期：2026-02-13
- 阶段/模块：M12 UI适配与验收测试（实机回归）
- 完成内容：
  - 在真机 `2211133C` 上执行 `connectedDebugAndroidTest` 多轮回归
  - 修复并稳定化测试：
    - `MigrationTest` 改为不依赖 Room schema 资产文件
    - 导航/入口增加 `testTag`（底部导航、复习标签、统计入口、拼写错误文案等）
    - 调整 M12 验收测试断言，降低文本唯一性与时序敏感性
  - 通过用例已覆盖：学习页、复习时间弹窗、查词/词库/我的核心流转、拼写模式入口、迁移验证
- 待办：
  - 修复剩余实机失败：
    - `SpellingScreenTest.spellingScreenRendersInDarkTheme`
    - `StatsContentTest.statsContentRendersInDarkTheme`
  - 补齐未执行完的其余 androidTest 用例（当前测试在失败后提前中断）
- 风险/阻塞：
  - 真机出现 `INSTALL_FAILED_USER_RESTRICTED`（安装被系统/用户侧拦截）导致定向复测中断
  - MIUI 设备环境噪声较大，`androidTest` 存在进程被系统中断风险
- 下一步：
  - 先解除设备安装限制后重跑全量 `connectedDebugAndroidTest`
  - 对剩余 2 个深色模式用例做进一步定向修复与复测

## 记录 #15
- 日期：2026-02-13
- 阶段/模块：M12 UI适配与验收测试（实机回归补测）
- 完成内容：
  - 修复 `M12AcceptanceTest` 里的乱码断言文本（“已掌握率”“学习统计”）
  - 修复 androidTest 兼容性问题：将 `assertExists` 调整为 `waitUntil + onAllNodesWithTag` 存在性断言
  - 调整 `coreFlowRegressionAndDarkModeSmoke`，降低页面切换时序导致的误报
  - 在真机 `bc4dfea4` 上使用 `JAVA_HOME=E:\\java_17` 执行 `connectedDebugAndroidTest`
  - 本轮结果：13 tests，0 failures，0 skipped，成功率 100%
- 待办：
  - 按计划补充手动实机验证（拼写页软键盘遮挡、不同屏幕尺寸）
- 风险/阻塞：
  - 测试环境需固定 JDK17；若回到高版本 JDK 可能再次触发 KSP 编译异常
- 下一步：
  - 继续执行文档要求的手动场景验收并记录截图/结论

## 记录 #16
- 日期：2026-02-13
- 阶段/模块：数据层优化与交付打包（词书去重 + APK）
- 完成内容：
  - 实现词书间同词唯一：新增全局词表与词书内容映射表，保证相同单词只保留一份 `word_id`。
  - 实现释义/例句按当前词书：查询链路改为按当前词书关联读取，搜索与学习展示保持词书上下文。
  - 数据库升级至 `v6` 并补充迁移逻辑（旧 `tb_word` 数据拆分迁移，进度/生词关联映射保持）。
  - 使用 `JAVA_HOME=E:\\java_17` 执行 `gradle :app:assembleDebug --no-daemon` 生成安装包。
  - APK 产物：`app/build/outputs/apk/debug/app-debug.apk`（17,112,777 bytes）。
- 待办：
  - 如需正式分发，补充 release 签名配置并生成 release 安装包。
- 风险/阻塞：
  - 当前产物为 debug 包，安装时会显示调试签名来源，不适合正式发布。
- 下一步：
  - 在目标设备安装 `app-debug.apk` 做一次回归验收（词书切换、查词释义、学习队列、生词本）。

## 记录 #17
- 日期：2026-02-13
- 阶段/模块：问题修复与实机回归（学习进度/内置词库/按钮交互）
- 完成内容：
  - 修复学习页交互锁定：将“答题提交中”状态下沉到 `LearningViewModel` 统一管理，避免点击“不认识”后三个按钮持续变灰无响应。
  - 修复学习进度显示：学习会话改为“已答题数 + 剩余队列”计数，导入词库场景下点击“认识/模糊/不认识”后进度可持续递增。
  - 修复 AGAIN 调度状态：`Sm2Scheduler` 在遗忘分支统一落库为 `LEARNING`，避免部分场景状态不更新导致进度统计异常。
  - 调整内置词库策略：预置词库仅保留“考研核心词汇”。
  - 增加内置词库清理逻辑：启动时清理不在预置清单内的旧内置词库，并去重同名内置词库。
  - 消除首启重复插入来源：移除数据库 `onCreate` 预填充回调，统一由 `ensurePresetBooks()` 进行初始化。
  - 新增并通过定向实机用例：`againActionDoesNotLockButtons`、`learningProgressAdvancesAfterAnswer`、`keepsOnlyOnePresetBook`。
  - 在真机 `2211133C`（adb: `bc4dfea4`）执行 `connectedDebugAndroidTest` 全量回归，结果：16 tests，0 failures，0 skipped。
- 待办：
  - 按你反馈的真实导入词库文件，再补一轮手动验收（连续点击三类按钮 + 跨词书切换）。
- 风险/阻塞：
  - MIUI 设备在长时间测试中偶发 `adb offline`，需在回归前确认设备连接稳定。
- 下一步：
  - 结合你常用导入词库样本，补充 1 条端到端仪器化用例（导入后学习进度与按钮可用性联合断言）。

## 记录 #18
- 日期：2026-02-13
- 阶段/模块：拼写模式算法优化（按文档落地）
- 完成内容：
  - 新增拼写结果分级模型：`PERFECT(5)`、`HINTED(4)`、`RETRY_SUCCESS(3)`、`FAILED(0)`，用于替代原先二元判定。
  - 新增 `SpellingEvaluator`，按“提示使用情况 + 尝试次数 + 正误”映射质量分。
  - 新增 `Sm2Scheduler.scheduleSpelling` 拼写专用调度：支持完美拼写间隔 +10% 奖励、失败更强惩罚、`EF` 下限放宽到 `1.1`。
  - `WordRepository` 新增 `applySpellingOutcome`：一次提交内统一更新学习进度、拼写对错计数、每日拼写次数与耗时。
  - `LearningViewModel` 改造拼写提交流程：接入分级结果；`FAILED/RETRY_SUCCESS` 加入会话即时重测队列；失败后进入“待继续”状态再切词。
  - `SpellingScreen` 重构为文档流程：最多 3 次尝试；第 3 次失败进入“抄写正确拼写后继续”；提示按钮参与扣分；提交时上报尝试次数与耗时。
  - 新增仪器化测试 `SpellingEvaluatorInstrumentedTest`（4 条），覆盖四类结果映射。
  - 实机回归（`2211133C` / `bc4dfea4`）通过：
    - `M12AcceptanceTest` 定向：7 tests，0 failures
    - `SpellingEvaluatorInstrumentedTest` 定向：4 tests，0 failures
    - 全量 `connectedDebugAndroidTest`：20 tests，0 failures，0 skipped
- 待办：
  - 补充“失败后抄写并继续”的稳定 UI 验收用例（规避实机 IME/焦点时序抖动）。
- 风险/阻塞：
  - 实机 UI 用例在键盘弹出与焦点切换阶段仍有偶发时序波动，需要继续降低断言敏感度。
- 下一步：
  - 在真实导入词库样本上做一轮手动拼写回归（提示使用、多次尝试、失败抄写、即时重测）并补充结论记录。

## 记录 #19
- 日期：2026-02-13
- 阶段/模块：拼写模式 UI 重设计与实机修复回归
- 完成内容：
  - 重设计 `SpellingScreen`：调整为“状态卡 + 题面卡 + 输入区 + 提示区 + 底部主操作”的信息层级，统一学习页视觉风格。
  - 修复实机 UI 可见性问题：将提交/继续按钮从滚动区拆分到底部固定操作区，避免小屏或内容较长时按钮不可见。
  - 保持拼写业务逻辑不变：尝试次数、提示扣分、失败抄写后继续、耗时上报流程未改变。
  - 保持已有测试标签不变：`spelling_input`、`spelling_submit`、`spelling_retry_hint`、`spelling_correct_answer`、`spelling_copy_input`、`spelling_continue_after_copy`。
  - 实机回归（`2211133C` / `bc4dfea4`）通过：
    - `SpellingScreenTest`：2 tests，0 failures
    - `M12AcceptanceTest#spellingFlowShowsWrongAnswerFeedback`：1 test，0 failures
- 待办：
  - 增加“长内容 + 小屏 + IME 弹出”场景下的 Compose UI 稳定性用例，降低未来回归成本。
- 风险/阻塞：
  - 无
- 下一步：
  - 基于当前通过版本生成并安装 APK，做一轮手工体验验收（拼写输入、提示、失败抄写、继续切词）。

## 记录 #20
- 日期：2026-02-13
- 阶段/模块：学习队列与进度一致性修复（跨词书共享 + 每日配额稳定）
- 完成内容：
  - 实现“同一单词跨词书共享背诵记录”：学习与拼写提交统一按 `wordId` 读取全局进度，并同步写回该词关联的所有词书进度记录。
  - 修复导入词书场景统计不一致：学习队列改为基于当前词书词集的全局进度去重计算，避免切换词书后状态割裂。
  - 新增“当前词书剩余新词 < 每日学习量”的处理机制：每日新词投放量改为 `min(当日剩余额度, 当前词书剩余新词)`。
  - 引入“今日已学习量”参与配额估算：修改每日学习量设置后，不再重置当天已学进度。
  - 调整 `LearningViewModel`：移除会话内新词配额缓存，改为每次加载队列动态估算当日剩余新词额度。
  - 补充并修正 M12 验收测试：
    - 新增 `sharedProgressAcrossBooksForSameWord`
    - 新增 `changingDailyLimitDoesNotResetTodayLearningProgress`
    - 修正 `sharedProgressAcrossBooksForSameWord` 的等待断言，避免单词量为 1 时索引断言抖动。
  - 编译与实机验证（JDK17: `E:\java_17`，设备：`2211133C`）通过：
    - `:app:compileDebugKotlin`
    - `:app:compileDebugAndroidTestKotlin`
    - `M12AcceptanceTest#importedBookRemainingCountDecreasesAfterAnswer`
    - `M12AcceptanceTest#sharedProgressAcrossBooksForSameWord`
    - `M12AcceptanceTest#changingDailyLimitDoesNotResetTodayLearningProgress`
    - `M12AcceptanceTest#learningProgressAdvancesAfterAnswer`
- 待办：
  - 在你常用的真实导入词书样本上补一轮手动回归，重点验证“认识/模糊/不认识”后剩余数量递减与跨词书一致性。
- 风险/阻塞：
  - 当前队列优先级在“全局进度去重后选取哪条记录”上采用 `reviewCount -> nextReviewTime -> id`，若后续有更细粒度业务规则需再调整。
- 下一步：
  - 基于当前通过版本继续生成并验证安装包，进入分发前回归阶段。

## 记录 #21
- 日期：2026-02-13
- 阶段/模块：学习算法 V3.0 落地（按《算法优化文档1.1》实现）
- 完成内容：
  - 重构 `Sm2Scheduler` 认词/拼写调度：
    - `AGAIN/FAILED` 统一改为 1 分钟后复习，并在会话内重试
    - 学习阶段步长改为 `HARD=10分钟`、`GOOD=1天`
    - 复习阶段 `HARD` 改为保守推进（约 `oldInterval * 1.2`），`GOOD` 按 `oldInterval * EF` 增长并保留 `2.5x` 安全阀
    - `MASTERED` 判定增加 `easeFactor >= 2.3`
  - 修复分钟级调度到期判断：`DateUtils.isDue` 增加绝对时间判断，避免 10 分钟卡片被误判“立即到期”。
  - 调整队列策略：`WordRepository.getStudyQueue` 从“复习后新词”改为“复习优先 + 3:1 穿插新词”。
  - 修正统计口径（按文档）：
    - 仅 `quality >= 3` 计入学习完成与 `review_count`
    - 新学词数仅在首次通过时计入
    - 复习词数仅在已学词且非 AGAIN 时计入
  - 优化拼写闭环与重试策略：
    - 拼写失败改为“抄写完成后再加入会话重试队列”
    - AGAIN 重试词插入规则改为：队列长度 `<=5` 放尾部，`>5` 随机插入 `[2, length-1]`
  - 使用 `JAVA_HOME=E:\\java_17` 完成构建验证：
    - `gradle :app:compileDebugKotlin --no-daemon` 通过
    - `gradle :app:assembleDebug --no-daemon` 通过
    - APK：`app/build/outputs/apk/debug/app-debug.apk`（17,321,213 bytes）
- 待办：
  - 增加/补齐针对新调度规则的自动化用例（AGAIN 1 分钟重试、3:1 队列穿插、统计口径断言）。
- 风险/阻塞：
  - 构建环境需固定 JDK17；高版本 JDK 可能触发 KSP 编译异常。
- 下一步：
  - 在目标设备安装最新 debug 包，手动回归“认词/拼写/队列流转/统计展示”四条主流程并记录结果。

## 记录 #22
- 日期：2026-02-14
- 阶段/模块：M13-M14 AI基础设施与AI实验室入口（V3.0）
- 完成内容：
  - 新增 AI 相关依赖与权限：
    - 依赖：Retrofit、OkHttp、Gson Converter、Jetpack Security
    - 权限：`android.permission.INTERNET`
  - 数据层扩展：
    - 新增 `AICache` 实体、`AICacheDao`
    - 数据库版本升级至 `v7`
    - 新增迁移 `MIGRATION_6_7`（创建 `tb_ai_cache` 与索引）
    - 迁移测试升级为 `migrate1To7_preservesProgressData`，并校验 `tb_ai_cache` 存在
  - AI 配置与安全存储：
    - 新增 `AIConfig`、`AIPresets`、`AIContentType`
    - 新增 `AISecureStorage`（`EncryptedSharedPreferences` 加密存储 API Key）
    - 新增 `AIConfigRepository`
  - 网络与仓储：
    - 新增 OpenAI 兼容数据模型与接口：`ChatModels`、`AIService`
    - 新增 `AIRepository`（Cache First、连通性测试、错误映射、写入缓存）
    - 新增 `PromptTemplates`（例句/助记/长难句）
  - UI 入口与设置页：
    - 新增 `AILabScreen`、`AILabViewModel`
    - “我的”页新增“AI 实验室”入口与状态摘要
    - 导航新增 `ai_lab` 路由并接入页面
  - 编译验证：
    - 在 `JAVA_HOME=E:\\java_17` 下执行 `gradle :app:compileDebugKotlin --no-daemon` 通过
- 待办：
  - M15：学习页接入 AI 例句生成与助记入口（含加载态/错误态/重试）
  - M16：查词页接入长难句解析模式（`>20` 字符自动触发）与结果缓存
  - M17：补齐 AI 内容卡片标识、免责声明与弱网异常交互
- 风险/阻塞：
  - 默认 JDK25 环境下 KSP 存在兼容问题（`java.lang.IllegalArgumentException: 25.0.2`），需固定 JDK17 构建
- 下一步：
  - 继续推进 M15 学习流程 AI 增强，并完成首轮 UI 交互与数据联调。

## 记录 #23
- 日期：2026-02-14
- 阶段/模块：M15 学习流程 AI 增强（首轮落地）
- 完成内容：
  - `LearningViewModel` 新增 AI 状态管理：
    - 新增 `LearningAiState`（可用性、加载态、当前类型、内容、错误）
    - 新增 `requestAiExample` / `requestAiMemoryAid` / `refreshAiAvailability`
    - 在“不认识（AGAIN）”与拼写失败后记录助记推荐目标词（`memoryAidSuggestionWordId`）
  - 学习页（认词模式）接入 AI：
    - `WordCard` 新增翻转状态回调，支持“翻卡后显示 AI 例句入口”
    - 新增 `LearningAiAssistPanel`：例句/助记按钮、加载态、错误重试、结果展示与免责声明
    - 新增 `AIContentResultCard` 统一展示 AI 返回内容
  - 拼写页（错误反馈）接入 AI 助记：
    - `SpellingScreen` 新增 AI 助记参数与回调
    - 在拼写错误与抄写纠错阶段展示 `SpellingAIAssistSection`
    - 支持“生成/重新生成助记”、加载态、错误态、结果卡片
  - 联调与验证：
    - `JAVA_HOME=E:\\java_17` 下 `gradle :app:compileDebugKotlin --no-daemon` 通过
    - `JAVA_HOME=E:\\java_17` 下 `gradle :app:compileDebugAndroidTestKotlin --no-daemon` 通过
- 待办：
  - M15 剩余：学习页 AI 入口与底部抽屉形态（灯泡入口）统一到 UI 规范
  - 增加针对 AI 交互的 UI 验收测试（按钮显隐、加载态、错误重试、结果展示）
- 风险/阻塞：
  - 构建环境仍需固定 JDK17，JDK25 下 KSP 兼容性问题未解除
- 下一步：
  - 继续完善 M15 的交互形态并补充自动化测试，再推进 M16 长难句解析。

## 记录 #24
- 日期：2026-02-14
- 阶段/模块：M15 学习流程 AI 增强（灯泡抽屉交互 + UI测试补齐）
- 完成内容：
  - 学习页 AI 交互改为“灯泡入口 + 底部抽屉”：
    - 新增 `learning_ai_bulb` 入口（未配置提示“去配置”，有推荐时高亮）
    - 点击灯泡：未配置弹引导对话框；已配置弹 `learning_ai_sheet` 底部抽屉
    - 抽屉动作：`learning_ai_action_example` / `learning_ai_action_memory`
    - 例句动作在翻卡后可用（未翻卡时给出提示）
  - 学习页 AI 结果反馈面板重构：
    - 新增 `LearningAiResultPanel`，覆盖建议提示、加载态、错误态、重试与结果展示
    - 新增测试标签：`learning_ai_loading`、`learning_ai_error`、`learning_ai_retry`、`learning_ai_content`、`learning_ai_suggestion`
  - M15 UI 验收测试补充：
    - `M12AcceptanceTest` 新增 `learningAiBulbShowsGuideWhenNotConfigured`
    - 新增 `LearningAiComponentsTest`（4 条）覆盖可见性、加载、错误重试、结果展示
  - 构建验证（JDK17）：
    - `gradle :app:compileDebugKotlin --no-daemon` 通过
    - `gradle :app:compileDebugAndroidTestKotlin --no-daemon` 通过
- 待办：
  - 在真机执行 M15 相关 `connectedDebugAndroidTest`，补充运行结果
  - 继续推进 M16：查词页长难句解析模式与缓存联调
- 风险/阻塞：
  - 构建仍需固定 JDK17（JDK25 下 KSP 兼容问题仍存在）
- 下一步：
  - 进入 M16 实现并补充查词页 AI 解析交互测试。

## 记录 #25
- 日期：2026-02-14
- 阶段/模块：M16 查词页长难句解析（自动模式 + 结构化展示）
- 完成内容：
  - `SearchViewModel` 接入长难句模式状态管理：
    - 新增 `SearchSentenceAiState` / `SentenceAnalysis`。
    - 监听查词输入，超过 `20` 字符自动进入句子解析模式并触发 `AIRepository.analyzeSentence`。
    - 保持原有 `results` 单词检索流独立，句子解析与查词并行执行、互不阻塞。
    - 新增句子解析结果结构化拆分（句子主干 / 语法成分标注 / 中文翻译）与重试入口。
  - `SearchScreen` 新增长难句解析面板：
    - 输入框支持长文本粘贴（句子模式下多行输入）。
    - 新增解析面板与测试标签：加载态、错误态、重试、重新解析、结构化结果展示。
    - 新增 AI 免责声明文案展示。
  - `PromptTemplates` 优化长难句 Prompt：
    - 强制模型按固定三段标题输出，提升结构化展示稳定性。
  - 新增 UI 组件测试 `SearchSentenceComponentsTest`（4 条）：
    - 覆盖句子模式显隐、加载态、错误重试、结构化结果与重新解析回调。
  - 构建验证（JDK17）：
    - `gradle :app:compileDebugKotlin --no-daemon` 通过
    - `gradle :app:compileDebugAndroidTestKotlin --no-daemon` 通过
  - 真机回归（`2211133C`）：
    - 执行 `gradle connectedDebugAndroidTest --no-daemon`（`JAVA_HOME=E:\java_17`）
    - 结果：`37 tests, 2 failures, 0 skipped`
    - 失败用例：
      - `M12AcceptanceTest#sharedProgressAcrossBooksForSameWord`
      - `M12AcceptanceTest#learningAiBulbShowsGuideWhenNotConfigured`
- 待办：
  - 重跑 `connectedDebugAndroidTest` 并补充回归结果（聚焦 `M12AcceptanceTest` 两条失败用例）。
  - 排查 `M12AcceptanceTest` 在真机上的节点查找失败（`learning_action_good` / `learning_ai_guide_confirm`）。
- 风险/阻塞：
  - 构建仍需固定 JDK17（JDK25 下 KSP 兼容问题仍存在）。
- 下一步：
  - 完成 M16 联调与真机验证后，推进 M17（AI 卡片标识、免责声明一致性与弱网错误提示细化）。

## 记录 #26
- 日期：2026-02-14
- 阶段/模块：M17 UI/UX 完善与错误治理（AI标识 + 风险提示 + 弱网重试 + 格式约束）
- 完成内容：
  - AI 卡片标识统一：
    - 新增通用角标组件 `AIGeneratedBadge`。
    - 学习页 `AIContentResultCard`、拼写页 `SpellingAIAssistSection`、查词句子解析面板统一展示“AI 生成”角标。
  - 风险与合规入口增强：
    - `AILabScreen` 新增“查看成本提示 / 查看隐私说明”入口与对应弹窗。
    - 增加测试标签：`ai_cost_entry`、`ai_privacy_entry`、`ai_cost_dialog_confirm`、`ai_privacy_dialog_confirm`。
  - 弱网错误治理：
    - `AIRepository` 增加一次重试策略（超时、域名解析失败、连接失败、`429`、`5xx`）。
    - 保持错误映射文案可读（超时、Key错误、额度受限、服务不可用等）。
  - AI 输出格式强约束：
    - `PromptTemplates` 新增 `systemInstruction`，对例句/助记/句子解析分别施加系统级格式约束。
    - 请求侧改为 `system + user` 双消息并设置 `temperature = 0f`（AI 内容请求）。
    - 新增 `AIContentFormatter` 作为兜底规范化，模型偏离模板时仍转换为预期展示格式。
  - 构建验证（JDK17）：
    - `gradle :app:compileDebugKotlin --no-daemon` 通过。
- 待办：
  - 在真机稳定完成新增 UI 交互回归（角标、风险提示入口、异常提示文案一致性）。
- 风险/阻塞：
  - 第三方聚合模型存在不完全遵循模板的情况，当前通过 `AIContentFormatter` 做兜底但仍需持续观察输出质量。
  - 构建仍需固定 JDK17（JDK25 下 KSP 兼容问题仍存在）。
- 下一步：
  - 进入 M18：补齐测试矩阵并执行联调回归与打包验收。

## 记录 #27
- 日期：2026-02-14
- 阶段/模块：M18 联调回归与发布验收（测试补齐 + 构建打包）
- 完成内容：
  - 单元测试补齐：
    - 新增 `PromptTemplatesTest`（含系统指令与模板断言）。
    - 新增 `AIRepositoryTest`（缓存命中、弱网重试、错误映射）。
    - 新增 `AIContentFormatterTest`（三类内容格式归一化断言）。
  - 数据与安全测试补齐：
    - 新增 `AICacheDaoInstrumentedTest`（读写、命中、过期清理）。
    - 新增 `AISecureStorageInstrumentedTest`（加密存储读写与明文不落盘检查）。
  - 交互测试补齐：
    - 新增 `AILabFlowTest`（配置保存流程、成本/隐私入口弹窗）。
    - 更新 `LearningAiComponentsTest`、`SearchSentenceComponentsTest` 以覆盖“AI 生成”角标断言。
    - 为 Profile 列表新增 `testTag("profile_list")` 支撑滚动定位。
  - 联调与回归执行：
    - `gradle :app:testDebugUnitTest --no-daemon`（JDK17）通过。
    - `gradle :app:compileDebugAndroidTestKotlin --no-daemon --rerun-tasks`（JDK17）通过。
    - 执行 `gradle connectedDebugAndroidTest --no-daemon`：本轮在真机 `2211133C` 出现历史失败与进程崩溃（含 `M12AcceptanceTest` 既有不稳定项），并出现部分新增 UI 用例失败，需继续稳定化。
  - 安装包产物：
    - `gradle :app:assembleDebug --no-daemon`（JDK17）通过。
    - 产物：`app/build/outputs/apk/debug/app-debug.apk`（18,802,361 bytes）。
- 待办：
  - 修复并稳定化真机失败用例（优先 `M12AcceptanceTest` 既有抖动项与新增 `AILabFlowTest`）。
  - 重跑全量 `connectedDebugAndroidTest` 并补齐最终验收统计。
  - 按 M18 要求补充手动回归记录（学习/查词/词书/我的四条主路径 + 弱网场景）。
- 风险/阻塞：
  - MIUI 真机回归存在进程崩溃与文件占用噪声，影响 `connectedDebugAndroidTest` 稳定性。
  - 构建环境仍需固定 JDK17。
- 下一步：
  - 先稳定并清零真机自动化失败，再进行最终发布前回归与文档收口。

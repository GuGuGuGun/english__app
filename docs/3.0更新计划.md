# 3.0 更新任务计划：考研离线背单词助手（Android，AI增强版）

## 目标与范围
- 在 V2.0 离线学习体系基础上，引入可选 AI 增强能力，不破坏既有学习主流程。
- 本次更新覆盖三类能力：智能例句生成、个性化助记、查词页长难句解析。
- 覆盖范围包含：设置管理、网络调用、缓存存储、页面交互、风险提示与验收测试。

## 约束与原则
- 离线优先：未配置 AI 或网络不可用时，应用保持完整可用。
- 用户自治（BYOK）：仅支持用户自带 API Key，不引入开发者中转服务。
- 安全优先：API Key 使用 EncryptedSharedPreferences 本地加密存储。
- 成本可控：AI 结果采用 Cache First，减少重复请求与 Token 消耗。
- 兼容优先：网络层采用 OpenAI Chat 兼容协议，支持多服务商与自定义端点。
- 体验优先：AI 功能不阻塞学习流程，失败可回退、可重试、可提示。

## 里程碑
- M13 基础设施与安全能力落地（依赖、权限、配置存储、数据库迁移）。
- M14 AI 实验室设置页交付（总开关、服务商配置、模型配置、连通性测试）。
- M15 学习流程 AI 增强交付（例句生成、助记生成、本地缓存）。
- M16 查词页长难句解析交付（自动识别句子模式、语法拆解结果展示）。
- M17 UI/UX 完善与错误治理（加载态、错误态、AI 标识、风险提示）。
- M18 联调回归与发布验收（稳定性、兼容性、文档更新）。

## 详细任务拆解

### 1. 基础设施与数据层（M13）
- 新增权限：`android.permission.INTERNET`。
- 新增依赖：OkHttp、Retrofit、Jetpack Security、Gson 或 kotlinx.serialization。
- 新增 `AIConfig` 数据类，定义 AI 开关、Base URL、模型等配置。
- 新增 `AICache` 实体与 `AICacheDao`。
- 完成 Room Migration（vCurrent -> vNext），确保历史数据不丢失。
- 实现 `AISecureStorage`，统一管理敏感配置的加密读写。

### 2. 网络层与仓储层（M13-M14）
- 定义 `AIService`（OpenAI Chat 兼容请求/响应结构）。
- 配置 OkHttp 拦截器（超时、日志、统一异常映射）。
- 新增 `PromptTemplates`，沉淀例句、助记、长难句解析模板。
- 实现 `AIRepository`：
  - Cache First 查询策略。
  - 按 `type` 分发 Prompt。
  - 统一返回成功/失败结果与错误信息。
  - 成功后写入本地缓存。

### 3. AI 实验室设置页（M14）
- 在“我的”页面新增“AI 实验室”入口与状态文案。
- 实现总开关：关闭后隐藏全局 AI 入口。
- 实现服务商预设与自定义 Base URL 输入。
- 实现 API Key 输入（显示/隐藏）与模型名称输入。
- 实现“测试连接”按钮与结果反馈。
- 可选：提供额度管理跳转入口。

### 4. 学习流程 AI 增强（M15）
- 学习页卡片翻转后展示“AI 生成真题例句”按钮。
- 查词详情页例句区底部接入同能力。
- 支持加载态、成功态、失败态和重新生成。
- 在“不认识”或拼写错误反馈界面提供“AI 助记”入口。
- 输出格式控制为短文本，适配快速阅读。
- 结果写入缓存，二次查看优先本地读取。

### 5. 查词页长难句解析（M16）
- 输入文本长度超过 20 字符时自动切换“句子解析”模式。
- 支持返回并展示：句子主干、语法成分标注、中文翻译。
- 对长难句解析结果做缓存，避免重复消耗。
- 与原有单词查询流程并行，不互相阻塞。

### 6. UI/UX 与合规提示（M17）
- 学习页新增“AI 灯泡”入口与底部抽屉能力面板。
- 未配置时弹出引导，已配置时展示生成入口。
- 按钮加载中禁用重复点击，避免重复请求。
- 错误使用可读提示（余额不足、超时、Key 错误等）。
- AI 卡片添加“AI 生成”角标与内容免责声明。
- 设置页增加成本提示、隐私说明入口。

### 7. 测试与验收（M18）
- 单元测试：Prompt 模板、Repository 分支逻辑、缓存命中逻辑。
- 数据测试：AICache 表读写、Migration 升级验证。
- 安全测试：API Key 加密存储正确性验证。
- 交互测试：设置页配置流程、学习页 AI 流程、查词页句子解析流程。
- 弱网测试：超时、重试、失败回退与不卡主流程。
- 回归测试：学习、查词、词书、我的 四大核心路径。

## 验收标准
- 未启用 AI 时，核心离线学习能力与 V2.0 行为一致。
- AI 配置可保存、可读取、可加密，重启后状态正确恢复。
- 例句/助记/长难句三类能力均可成功请求并正确展示。
- 同一输入命中缓存时不重复请求网络。
- 网络异常、额度不足、Key 错误均有明确提示且不阻断学习。
- UI 中 AI 内容具备明确标识与免责声明。
- Room Migration 通过，历史数据完整保留。

## 交付物
- 新增/更新代码：`AICache`、`AICacheDao`、`AIConfig`、`AIService`、`AIRepository`、`AISecureStorage`、`PromptTemplates`。
- 新增/更新页面：`AILabScreen`、`AIContentCard`、`LearningScreen` AI 入口、`SearchScreen` 句子解析入口。
- 数据库迁移脚本（vCurrent -> vNext）。
- 完整测试记录与回归结果。
- 文档更新：`docs/开发进度记录.md`、相关说明文档。

## 开发进度记录要求
- 记录文件：`docs/开发进度记录.md`。
- 记录频率：每个里程碑（M13-M18）完成后更新。
- 记录内容：完成内容、待办、风险/阻塞、下一步。
- 若与计划偏差，必须记录原因与调整方案。

## 记录模板
- 日期：
- 阶段/模块：
- 完成内容：
- 待办：
- 风险/阻塞：
- 下一步：
